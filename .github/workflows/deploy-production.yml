name: Deploy API to Cloud Run

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: europe-west1-docker.pkg.dev
  IMAGE_NAME: context-ai-api/api

jobs:
  test:
    name: Test & Build
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: contextai_test
          POSTGRES_USER: contextai_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Lint
        run: pnpm lint

      - name: Build
        run: pnpm build

      - name: Test
        run: pnpm test
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USERNAME: contextai_user
          DB_PASSWORD: test_password
          DB_DATABASE: contextai_test
          NODE_ENV: test

  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'

    permissions:
      contents: read
      id-token: write

    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }}

      - name: Build and Push Docker image
        run: |
          docker build \
            --build-arg NODE_AUTH_TOKEN=${{ secrets.GH_PACKAGES_TOKEN }} \
            -t ${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -t ${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}:latest \
            .
          docker push ${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}:latest

      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: context-ai-api
          region: europe-west1
          image: ${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          env_vars: |
            NODE_ENV=production
            API_PREFIX=api/v1
            DB_HOST=${{ secrets.DB_HOST }}
            DB_PORT=5432
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_DATABASE=contextai
            DB_SSL_REJECT_UNAUTHORIZED=false
            PINECONE_INDEX=context-ai
            FRONTEND_URL=${{ secrets.FRONTEND_URL }}
            ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS }}
            RATE_LIMIT_WINDOW_MS=60000
            RATE_LIMIT_MAX_REQUESTS=100
            LOG_LEVEL=info
          secrets: |
            DB_PASSWORD=DB_PASSWORD:latest
            GOOGLE_API_KEY=GOOGLE_API_KEY:latest
            PINECONE_API_KEY=PINECONE_API_KEY:latest
            AUTH0_DOMAIN=AUTH0_DOMAIN:latest
            AUTH0_AUDIENCE=AUTH0_AUDIENCE:latest
            AUTH0_ISSUER=AUTH0_ISSUER:latest
            AUTH0_MGMT_DOMAIN=AUTH0_MGMT_DOMAIN:latest
            AUTH0_MGMT_CLIENT_ID=AUTH0_MGMT_CLIENT_ID:latest
            AUTH0_MGMT_CLIENT_SECRET=AUTH0_MGMT_CLIENT_SECRET:latest
            AUTH0_DB_CONNECTION=AUTH0_DB_CONNECTION:latest
            SENTRY_DSN=SENTRY_DSN:latest
            INTERNAL_API_KEY=INTERNAL_API_KEY:latest
          flags: |
            --port=3001
            --memory=512Mi
            --cpu=1
            --min-instances=0
            --max-instances=3
            --concurrency=80
            --timeout=300
            --allow-unauthenticated

      - name: Smoke Test
        run: |
          URL="${{ steps.deploy.outputs.url }}"
          echo "üîç Running smoke test against: $URL/api/v1"

          # Wait for service to be ready (Cloud Run cold start)
          for i in $(seq 1 5); do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL/api/v1" || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ Health check passed (attempt $i)"
              exit 0
            fi
            echo "‚è≥ Attempt $i: status $STATUS, retrying in 10s..."
            sleep 10
          done

          echo "‚ùå Health check failed after 5 attempts"
          exit 1

      - name: Notify deployment success
        if: success()
        run: |
          echo "üöÄ Deployment successful!"
          echo "   Service URL: ${{ steps.deploy.outputs.url }}"
          echo "   Image: ${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo "   Commit: ${{ github.sha }}"

